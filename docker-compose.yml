services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: uinsure-sql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql

  db-init:
    image: mcr.microsoft.com/mssql-tools:latest
    container_name: uinsure-sql-init
    depends_on:
      - db
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}
    volumes:
      - ./Uinsure.TechnicalTest.Database:/db:ro
    command:
      - /bin/bash
      - -c
      - |
        for i in {1..60}; do
          /opt/mssql-tools/bin/sqlcmd -S db -U sa -P "$$MSSQL_SA_PASSWORD" -Q "SELECT 1" && break
          echo "waiting for sql server..."
          sleep 2
        done
        /opt/mssql-tools/bin/sqlcmd -S db -U sa -P "$$MSSQL_SA_PASSWORD" -Q "IF DB_ID(N'UinsureTechnicalTest') IS NULL CREATE DATABASE [UinsureTechnicalTest];"
        for f in /db/dbo/tables/Policies.sql /db/dbo/tables/Policyholders.sql /db/dbo/tables/Properties.sql /db/dbo/tables/Payments.sql; do
          /opt/mssql-tools/bin/sqlcmd -S db -U sa -P "$$MSSQL_SA_PASSWORD" -d UinsureTechnicalTest -i "$$f"
        done

  api:
    build:
      context: .
      dockerfile: Uinsure.TechnicalTest.API/Dockerfile
    container_name: uinsure-api
    depends_on:
      - db
      - db-init
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__PolicyContext: "Data Source=db,1433;Initial Catalog=UinsureTechnicalTest;MultipleActiveResultSets=True;User id=sa;Password=${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd};TrustServerCertificate=True"
    ports:
      - "5019:8080"

volumes:
  mssql-data:
